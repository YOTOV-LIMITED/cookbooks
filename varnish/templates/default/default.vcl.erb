backend app_server {
  .host = "<%= @node[:varnish][:app_proxy_host] %>";
  .port = "<%= @node[:varnish][:app_proxy_port] %>";
}

backend static_server {
  .host = "<%= @node[:varnish][:static_proxy_host] %>";
  .port = "<%= @node[:varnish][:static_proxy_port] %>";
}

sub vcl_recv {
    # set the backend server based on request (if multi-server stack)
  <% if @node[:chef][:roles].include?('staging') %>
    set req.backend = app_server;
  <% elsif @node[:chef][:roles].include?('proxy') %>
    if (req.url ~ "^/images" || req.url ~ "^/javascripts" || req.url ~ "^/flash" || req.url ~ "^/stylesheets" || req.url ~ "^/sitemaps"  || req.url ~ "^/articles/html" || req.url ~ "^/articles/xml") {
      set req.backend = static_server;
      return (lookup);
    } else {
      set req.backend = app_server;
    }
  <% end %>
    
  
    /* Reject Non-RFC2616 or CONNECT or TRACE requests. */
    if (req.request != "GET" &&
      req.request != "HEAD" &&
      req.request != "PUT" &&
      req.request != "POST" &&
      req.request != "OPTIONS" &&
      req.request != "DELETE") {
        return (pipe);
    }
    
    /* Compression handled upstream; only want one in the cache */
    if (req.http.Accept-Encoding) {
        remove req.http.Accept-Encoding;
    }
    
    /* Add a unique header containing the client address */
    remove req.http.X-Forwarded-For;
    set    req.http.X-Forwarded-For = client.ip;
    
    /* Pass POSTs etc directly on to the backend */
    if (req.request != "GET" && req.request != "HEAD") {
        return (pass);
    }
    
    /* Pass admin requests directly on to the backend */
    if (req.url ~ "^/admin/") {
        return (pass);
    }
      
    /* Prevent duplication of caches */
    set req.http.host = "<%= @node[:varnish][:proxy_host_name] %>";
    
    /* Check to see if cached */
    return (lookup);
}

sub vcl_fetch {
    /* Directly serve static content */
    if (req.url ~ "^/images" || req.url ~ "^/javascripts" || req.url ~ "^/flash" || req.url ~ "^/stylesheets" || req.url ~ "^/sitemaps" || req.url ~ "^/articles/html" || req.url ~ "^/articles/xml") {
        return(deliver);
    }
    /* ESI process the rest */
    else {
        esi;
    }
}


