# user <%= @node[:nginx][:user] %>;
worker_processes  <%= @node[:nginx][:worker_processes] %>;

<% if @node[:nginx][:daemon_disable] -%>
daemon off;
<% end -%>

error_log  <%= @node[:nginx][:log_dir] %>/error.log;
pid        /var/run/nginx.pid;

events {
  worker_connections  <%= @node[:nginx][:worker_connections] %>;
  # more efficient on linux
  use epoll;
}

http {
  include       <%= @node[:nginx][:dir] %>/mime.types;
  default_type  application/octet-stream;

  access_log	<%= @node[:nginx][:log_dir] %>/access.log;

  sendfile on;
  tcp_nopush on;
  tcp_nodelay on;

  <% if @node[:nginx][:keepalive] == "on" %>
  keepalive_timeout  <%= @node[:nginx][:keepalive_timeout] %>;
  <% end %>

  gzip  <%= @node[:nginx][:gzip] %>;
  <% if @node[:nginx][:gzip] == "on" %>
  gzip_http_version <%= @node[:nginx][:gzip_http_version] %>;
  gzip_comp_level <%= @node[:nginx][:gzip_comp_level] %>;
  gzip_proxied <%= @node[:nginx][:gzip_proxied] %>;
  gzip_buffers <%= @node[:nginx][:gzip_buffers] %>;
  gzip_min_length <%= @node[:nginx][:gzip_min_length] %>;
  gzip_types <%= @node[:nginx][:gzip_types].join(' ') %>;
  gzip_disable  msie6;
  <% end %>

  server_names_hash_bucket_size <%= @node[:nginx][:server_names_hash_bucket_size] %>;
  
  <% if @node[:nginx][:varnish_proxy] %>
  upstream varnish {
    server <%= @node[:nginx][:varnish_proxy_host] %>:<%= @node[:varnish][:listen_port] %> weight=<%= @node[:nginx][:varnish_weight] %> max_fails=<%= @node[:nginx][:varnish_max_fails] %> fail_timeout=<%= @node[:nginx][:varnish_fail_timeout] %>;
  }
  <% end %>
  
  server {
    listen <%= @node[:nginx][:listen_port] %>;
    server_name www.<%= @node[:nginx][:host_name] %> <%= @node[:nginx][:host_name] %>;
    
    access_log /var/log/nginx/<%= @node[:nginx][:host_name] %>/access.log;
    error_log /var/log/nginx/<%= @node[:nginx][:host_name] %>/error.log;

    <% if @node[:nginx][:varnish_proxy] %>
    location /admin {
      rewrite  ^/(admin($|/.*))  https://<%= @node[:nginx][:host_name] %>/$1  permanent;
    }
    <% end %>
    
    location / {
      client_max_body_size <%= @node[:nginx][:client_max_body_size] %>;
      
      <% if @node[:nginx][:varnish_proxy] %>
      auth_basic            "Restricted";
      auth_basic_user_file  auth/htpasswd;

      proxy_pass             http://varnish;
      proxy_redirect         http://varnish/ http://$host:$server_port/;
      proxy_set_header       Host $host;
      proxy_set_header       X-Real-IP $remote_addr;
      proxy_set_header       X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header       X-Client-Verify SUCCESS;
      proxy_set_header       X-SSL-Subject $ssl_client_s_dn;
      proxy_set_header       X-SSL-Issuer  $ssl_client_i_dn;
      <% elsif @node[:chef][:roles].include?('static') %>
      # doc root
      root <%= @node[:nginx][:doc_root] %>;
      
      # If the file exists as a static file serve it directly without
      # running all the other rewrite tests on it
      if (-f $request_filename) { 
        break; 
      }
      <% end %>      
    }
    
    <% if @node[:chef][:roles].include?('static') %>
      error_page 500  /500_static.html;  
      location = /500_static.html {  
          root  <%= @node[:nginx][:doc_root] %>;  
      }
      error_page 404  /404_static.html;  
      location = /404_static.html {  
          root  <%= @node[:nginx][:doc_root] %>;  
      }
    <% end %>
  }
  
  <% if @node[:nginx][:varnish_proxy] %>
  server {
    listen   443;
    ssl on;
    ssl_certificate /etc/ssl/certs/fr2_admin.crt;
    ssl_certificate_key /etc/ssl/private/fr2_admin.key;
    
    server_name www.<%= @node[:nginx][:host_name] %> <%= @node[:nginx][:host_name] %>;
    
    # redirect www
    if ($host ~* www\.(.*)) {
      set $host_without_www $1;
      rewrite ^(.*)$ https://$host_without_www$1 permanent; # $1 contains '/foo', not 'www.mydomain.com/foo'
    }
    
    access_log /var/log/nginx/<%= @node[:nginx][:host_name] %>/ssl-access.log;
    error_log /var/log/nginx/<%= @node[:nginx][:host_name] %>/ssl-error.log;
    
    location / {
      proxy_pass             http://varnish;
      proxy_redirect         http://varnish/ http://$host:$server_port/;
      proxy_set_header       Host $host;
      proxy_set_header       X-Real-IP $remote_addr;
      proxy_set_header       X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header       X-Client-Verify SUCCESS;
      proxy_set_header       X-SSL-Subject $ssl_client_s_dn;
      proxy_set_header       X-SSL-Issuer  $ssl_client_i_dn;
    }
  }
  <% end %>

  include <%= @node[:nginx][:dir] %>/conf.d/*.conf;
  #include <%= @node[:nginx][:dir] %>/sites-enabled/*;
}
